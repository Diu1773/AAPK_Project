# =============================================================================
# AutoAperturePhot_KNUEMAO - Example Configuration File
# =============================================================================

[io]
data_dir = "./data"
filename_prefix = "pp_"
result_dir = ""                     # Empty = data_dir/result
cache_dir = "cache"
airmass_formula = "Kasten & Young (1989)"
airmass_update_header = false
airmass_update_mode = "overwrite"

[target]
name = "M67"
# ra_deg = 82.17
# dec_deg = 35.83

[parallel]
mode = "thread"                     # thread | process | auto | none
max_workers = 0
resume_mode = true
force_redetect = false
force_rephot = false
detect_cache_strategy = "mtime"

[ui]
log_tail = 300
detect_progress_bar = true
canvas_px = 900

[instrument]
telescope_focal_mm = 3947.0
camera_pixel_um = 3.76
binning = 2
gain_e_per_adu = 0.1
rdnoise_e = 1.39                    # REQUIRED
saturation_adu = 60000.0
zp_initial = 25.0
datamin_adu = 0.1
datamax_adu = 55000.0

[alignment]
ref_index = 0
global_align = true
global_ref_filter = "r"
global_ref_index = 0

[refbuild]
mode = "hybrid"                     # single | stacked | gaia | hybrid
gaia_mag_limit = 18.0               # Gaia magnitude limit for hybrid mode
per_date = true
sat_drop_pct = 20.0
elong_drop_pct = 20.0
ref_cat_max_sources = 0
ref_cat_min_sources = 50
ref_cat_max_elong = 1.5
ref_cat_max_abs_round = 0.4
ref_cat_sharp_min = 0.2
ref_cat_sharp_max = 1.0
ref_cat_min_peak_adu = 0.0
wcs_match_radius_arcsec = 2.0
wcs_min_match_rate = 0.2
wcs_min_match_n = 50
wcs_max_sep_med_arcsec = 1.5
wcs_max_sep_p90_arcsec = 2.5
wcs_max_dup_rate = 0.1

[fwhm]
guess_arcsec = 2.5
px_min = 3.5
px_max = 12.0
elong_max = 1.3
iso_min_sep_pix = 18.0

[idmatch]
tol_arcsec = 2.0
match_r_fwhm = 0.8
init_r_fwhm = 5.0
ratio_max = 0.7
min_pairs = 15
transform_mode = "similarity"
mutual_nearest = true
two_pass_enable = true              # Enable two-pass matching (tight -> loose)
tight_radius_arcsec = 1.0           # Pass 1: high confidence matches
loose_radius_arcsec = 3.0           # Pass 2: remaining matches

[detection]
engine = "dao"
sigma = 3.2
sigma_g = 3.2
sigma_r = 3.2
sigma_i = 3.4
minarea_pix = 3
keep_max = 6000
dilate_radius_px = 4

[detection.deblend]
enable = true
nthresh = 64
contrast = 0.0025
max_labels = 4000
label_hard_max = 7000

[detection.dao]
enable = true
fwhm_px = 6.0
sharp_lo = 0.2
sharp_hi = 1.0
round_lo = -0.5
round_hi = 0.5
match_tol_px = 2.0

[background]
enable = true
in_detect = true
box = 64
filter_size = 3
edge_method = "pad"
method = "median"
downsample = 4

[qc]
gate_enable = true

[photometry]
mode = "apcorr"
recenter = true
use_segm_mask = true
min_snr_for_mag = 3.0
use_qc_pass_only = false
use_original_frames = true

[photometry.scales]
aperture_scale = 1.0
annulus_scale = 4.0
dannulus_scale = 2.0
center_cbox_scale = 1.5
annulus_min_gap_px = 6.0
annulus_min_width_px = 12.0

[photometry.radii]
min_r_ap_px = 4.0
min_r_in_px = 12.0
min_r_out_px = 20.0
sigma_clip = 3.0
max_iter = 5
neighbor_mask_scale = 1.3

[photometry.apcorr]
apply = true
small_scale = 1.0
large_scale = 3.0
min_n = 20
scatter_max = 0.05
min_snr = 40.0

[hud5x]
aperture_scale = 1.0
center_cbox_scale = 1.5
annulus_in_scale = 4.0
annulus_out_scale = 2.0
sigma_clip = 3.0
neighbor_mask_scale = 1.3
mag_flux = "rate_e"
use_header_exptime = true
min_r_ap_px = 12.0
min_r_in_px = 24.0
min_r_out_px = 36.0

[wcs]
do_plate_solve = true
astap_exe = "C:/Program Files/astap/astap_cli.exe"
astap_timeout_s = 120.0
astap_search_radius_deg = 8.0
astap_database = "D50"
astap_fov_fudge = 1.0
astap_downsample = 2
astap_max_stars = 500
astnet_local_enable = false
astnet_local_use_wsl = true
astnet_local_command = "solve-field"
astnet_local_timeout_s = 300.0
astnet_local_downsample = 2
astnet_local_scale_low = 0.0
astnet_local_scale_high = 0.0
astnet_local_radius_deg = 8.0
astnet_local_keep_outputs = true
astnet_local_use_cache = true
astnet_local_max_objs = 2000
astnet_local_cpulimit_s = 30.0
propagate_max_shift_px = 50.0
propagate_min_match = 12
propagate_sigma_clip = 3.0
max_workers = 2
require_qc_pass = true
refine_enable = true

[match]
tol_px = 1.0
wcs_radius_arcsec = 1.0
min_gaia_matches = 10

[cmd]
snr_calib_min = 20.0
max_sources = 5000

[cmd.zp]
clip_sigma = 3.0
fit_iters = 5
slope_absmax = 1.0

[cmd.color]
clip_sigma = 3.0
fit_iters = 5
slope_absmax = 2.0

[overlay]
max_labels = 2000

[light_curve]
# Optional atmospheric color-term correction in light curve builder.
# Keys must match FILTER values in headers/index (case-insensitive).
color_term_by_filter = { g = 0.0, r = 0.0, i = 0.0 }
# Per-filter color index (not fixed to g-r). Examples: "g-r", "r-i".
color_index_by_filter = { g = "g-r", r = "g-r", i = "r-i" }

[extinction_fit]
order = 1
min_points = 5
clip_sigma = 3.0
fit_iters = 5
use_color_terms = false
color_index_by_filter = { g = "g-r", r = "g-r", i = "r-i" }
color_c1_by_filter = { g = 0.0, r = 0.0, i = 0.0 }
color_c2_by_filter = { g = 0.0, r = 0.0, i = 0.0 }

[tools.qa_report]
min_n_frames = 3
min_snr = 5.0
max_chi2_nu = 5.0
max_delta_r = 2.0
exclude_saturated = true
error_model_source = "raw"
frame_flag_mode = "absolute"
frame_snr_min = 10.0
frame_goodmag_min = 0.9
frame_fwhm_mode = "scale"
frame_fwhm_scale = 1.5
frame_fwhm_abs = 8.0
enabled_filters_all = true
enabled_filters = []
